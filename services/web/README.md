# Spendflix Web - Frontend HTMX

Static frontend for signup using HTMX, Go templates (build time), and TailwindCSS.

## Structure

```
web/
  cmd/build/main.go          # Go build tool
  templates/                 # Go templates (source)
  assets/src/                # TypeScript and CSS (source)
  dist/                      # Generated by build (deploy)
  public/                    # Static assets (logo, etc)
```

## Setup

### 1. Install Dependencies

```bash
cd services/web
npm install
```

### 2. Build

```bash
# Full build (assets + HTML)
make build

# Or manually:
npm run build:all          # Compile CSS and TypeScript
go run cmd/build/main.go   # Compile Go templates → HTML
```

## Development

Start development server with watch mode:

```bash
cd services/web
make dev
```

This will:
1. Build initial files (CSS, TypeScript, HTML)
2. Start watch mode for CSS/TypeScript (auto-rebuild on changes)
3. Start HTTP server on `http://localhost:8080`

Access: `http://localhost:8080`

**Note:** When you change Go templates, you need to rebuild HTML manually:
```bash
go run cmd/build/main.go
```

## Testing

E2E tests using Playwright to validate the complete signup flow.

### Prerequisites

- Node.js 20+
- Go 1.23+
- PostgreSQL (for running the API locally)

### Running Tests Locally

#### 1. Setup

```bash
# Install dependencies
cd services/web
npm install

# Install Playwright browsers
npx playwright install --with-deps chromium
```

#### 2. Configure Environment Variables

Make sure the API is properly configured in `services/auth/.env`:

```env
DATABASE_URL=postgres://user:password@localhost:5432/spendflix?sslmode=disable
PORT=3000
ENCRYPTION_SECRET=your-secret-key
```

#### 3. Run Tests

```bash
# Run all tests (headless - default)
# Automatically starts servers
npm test

# Run with visible browser (local)
npm run test:local

# Run with Playwright interactive UI
npm run test:ui

# Run fast tests (skips build if servers already running)
# Useful when you already have servers running manually
npm run test:fast

# Use environment variable directly
HEADLESS=false npm test
```

**Tip for fast development:**

If you already have servers running (`make dev` in another terminal), use:

```bash
npm run test:fast
```

This skips the build and starts tests immediately, saving time.

### Test Structure

- `tests/signup.spec.ts` - Signup flow tests:
  - Field validation (name and email)
  - Form submission
  - Confirmation code display
  - API error handling

### How It Works

Playwright automatically:
1. Starts the API at `http://localhost:3000`
2. Starts the web server at `http://localhost:8080`
3. Runs tests in headless browser
4. Cleans up processes when finished

### Debugging

To debug tests:

```bash
# Run a specific test
npx playwright test signup.spec.ts

# Run with debug mode
npx playwright test --debug

# View HTML report
npx playwright show-report
```

### CI/CD

Tests run automatically on GitHub Actions when there are changes in:
- `services/web/**`
- `services/auth/**`

The workflow is in `.github/workflows/web-e2e.yml`.

## Environment Variables

- `API_GATEWAY_URL`: API Gateway URL (default: `http://localhost:3000`)

### Getting API Gateway URL

To get the API Gateway URL from the deployed auth service:

```bash
cd services/auth
serverless info --stage dev
```

Look for the `endpoint` line in the output. The base URL (without the `/auth/sign-up` path) should be used for `API_GATEWAY_URL`.

Example output:
```
endpoint: POST - https://yrltx77a47.execute-api.us-east-2.amazonaws.com/auth/sign-up
```

In this case, set `API_GATEWAY_URL=https://yrltx77a47.execute-api.us-east-2.amazonaws.com`

## AWS Amplify Configuration

### Prerequisites

1. **Go Runtime**: Amplify needs Go installed to compile templates. Configure this in the Amplify console:
   - Go to your app settings → Build settings
   - Add Go to the build image or use a custom build image with Go pre-installed

2. **Environment Variables**: Set the following in Amplify Console → App settings → Environment variables:
   - `API_GATEWAY_URL`: Your API Gateway URL (e.g., `https://api.example.com`)

### Build Configuration

The `amplify.yml` file is already configured with the following build steps:

```yaml
version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm install
        - npm run build:all
        - go run cmd/build/main.go
    build:
      commands:
        - echo "Build completed in preBuild phase"
  artifacts:
    baseDirectory: dist
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
```

### Deployment Steps

#### Option 1: Deploy Without Git (Recommended for Testing)

You can deploy directly without connecting to Git repository:

```bash
# 1. Build locally
cd services/web
make build

# 2. Create deployment
DEPLOYMENT=$(aws amplify create-deployment \
  --app-id d37t3chm3rgne2 \
  --branch-name main \
  --region us-east-2 \
  --output json)

JOB_ID=$(echo $DEPLOYMENT | jq -r '.jobId')
ZIP_URL=$(echo $DEPLOYMENT | jq -r '.zipUploadUrl')

# 3. Upload built files
cd dist
zip -r ../deploy.zip .
curl -X PUT "$ZIP_URL" --upload-file ../deploy.zip
cd ..

# 4. Start deployment
aws amplify start-job \
  --app-id d37t3chm3rgne2 \
  --branch-name main \
  --job-id $JOB_ID \
  --job-type RELEASE \
  --region us-east-2

# Clean up
rm deploy.zip
```

#### Option 2: AWS Console (Manual with Git)

1. **Get API Gateway URL**: 
   ```bash
   cd services/auth
   serverless info --stage dev
   ```
   Copy the base URL from the `endpoint` output (without the `/auth/sign-up` path).

2. **Connect Repository**: Connect your GitHub repository to AWS Amplify
3. **Configure Build Settings**: 
   - Root directory: `services/web`
   - Build image: Use a build image with Go 1.21+ installed (or configure custom build image)
4. **Set Environment Variables**: Add `API_GATEWAY_URL` in the Amplify console with the URL obtained in step 1
5. **Deploy**: Amplify will automatically:
   - Run `npm install`
   - Run `npm run build:all` (compiles CSS and TypeScript)
   - Run `go run cmd/build/main.go` (compiles Go templates)
   - Serve content from `dist/` directory

#### Option 3: AWS CLI (Programmatic with Git)

You can configure Amplify programmatically using AWS CLI:

```bash
# First, get the API Gateway URL from the auth service
cd services/auth
API_GATEWAY_URL=$(serverless info --stage dev | grep endpoint | sed 's/.*https:\/\/\([^/]*\).*/https:\/\/\1/')

# Create Amplify app
aws amplify create-app \
  --name spendflix-web \
  --platform WEB \
  --environment-variables API_GATEWAY_URL=$API_GATEWAY_URL \
  --region us-east-2

# Note: Repository connection requires GitHub OAuth token
# Connect repository via AWS Console: App settings → General → Repository
# Or use: aws amplify create-deployment --app-id <app-id> --branch-name main

# Create branch
aws amplify create-branch \
  --app-id <app-id> \
  --branch-name main \
  --framework WEB

# Set environment variables (get API_GATEWAY_URL from auth service first)
cd services/auth
API_GATEWAY_URL=$(serverless info --stage dev | grep endpoint | sed 's/.*https:\/\/\([^/]*\).*/https:\/\/\1/')
aws amplify update-app \
  --app-id <app-id> \
  --environment-variables API_GATEWAY_URL=$API_GATEWAY_URL \
  --region us-east-2

# Start deployment from Git (requires repository connection)
aws amplify start-job \
  --app-id <app-id> \
  --branch-name main \
  --job-type RELEASE \
  --region us-east-2
```

#### Option 3b: Deploy Without Git Push (Direct Upload)

You can deploy directly without pushing to Git by uploading the built files:

```bash
# 1. Build locally first
cd services/web
make build

# 2. Create a deployment (this creates a zip file upload URL)
DEPLOYMENT=$(aws amplify create-deployment \
  --app-id <app-id> \
  --branch-name main \
  --region us-east-2 \
  --output json)

# Extract jobId and zipUploadUrl from the response
JOB_ID=$(echo $DEPLOYMENT | jq -r '.jobId')
ZIP_URL=$(echo $DEPLOYMENT | jq -r '.zipUploadUrl')

# 3. Create zip file from dist/ directory
cd dist
zip -r ../deploy.zip .

# 4. Upload zip file to the provided URL
curl -X PUT "$ZIP_URL" --upload-file ../deploy.zip

# 5. Start the deployment job
aws amplify start-job \
  --app-id <app-id> \
  --branch-name main \
  --job-id $JOB_ID \
  --job-type RELEASE \
  --region us-east-2

# Clean up
rm ../deploy.zip
```

**Alternative:** You can also use the Amplify Console → "Deploy without Git repository" option for a simpler UI-based deployment.

#### Option 4: AWS SDK (Go)

You can also use the AWS SDK for Go to configure Amplify programmatically:

```go
package main

import (
    "github.com/aws/aws-sdk-go/aws"
    "github.com/aws/aws-sdk-go/aws/session"
    "github.com/aws/aws-sdk-go/service/amplify"
)

func createAmplifyApp() error {
    sess := session.Must(session.NewSession())
    svc := amplify.New(sess)

    // Get API Gateway URL from auth service deployment
    // Run: cd services/auth && serverless info --stage dev
    // Extract base URL from endpoint output
    apiGatewayURL := "https://yrltx77a47.execute-api.us-east-2.amazonaws.com" // Replace with actual URL

    input := &amplify.CreateAppInput{
        Name: aws.String("spendflix-web"),
        Repository: aws.String("https://github.com/sauloarruda/spendflix.git"),
        Platform: aws.String("WEB"),
        EnvironmentVariables: map[string]*string{
            "API_GATEWAY_URL": aws.String(apiGatewayURL),
        },
        BuildSpec: aws.String(`
version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm install
        - npm run build:all
        - go run cmd/build/main.go
    build:
      commands:
        - echo "Build completed"
  artifacts:
    baseDirectory: dist
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
        `),
    }

    result, err := svc.CreateApp(input)
    if err != nil {
        return err
    }

    // Create branch
    branchInput := &amplify.CreateBranchInput{
        AppId:      result.App.AppId,
        BranchName: aws.String("main"),
        Framework:  aws.String("WEB"),
    }

    _, err = svc.CreateBranch(branchInput)
    return err
}
```

#### Option 5: Terraform/CDK

For Infrastructure as Code, you can use Terraform or AWS CDK:

**Terraform example:**
```hcl
# Get API Gateway URL first:
# cd services/auth && serverless info --stage dev
# Extract base URL from endpoint output

resource "aws_amplify_app" "web" {
  name       = "spendflix-web"
  repository = "https://github.com/sauloarruda/spendflix.git"
  platform   = "WEB"

  environment_variables = {
    API_GATEWAY_URL = "https://yrltx77a47.execute-api.us-east-2.amazonaws.com" # Replace with actual URL
  }

  build_spec = file("${path.module}/amplify.yml")
}

resource "aws_amplify_branch" "main" {
  app_id      = aws_amplify_app.web.id
  branch_name = "main"
  framework   = "WEB"
}
```

### Custom Build Image (Optional)

If your default Amplify build image doesn't include Go, you can use a custom build image or add Go installation:

```yaml
preBuild:
  commands:
    - curl -L https://go.dev/dl/go1.21.0.linux-amd64.tar.gz -o go.tar.gz
    - sudo tar -C /usr/local -xzf go.tar.gz
    - export PATH=$PATH:/usr/local/go/bin
    - npm install
    - npm run build:all
    - go run cmd/build/main.go
```

### Build Output

The build process generates:
- **Assets** (CSS/JS): Compiled to `dist/assets/`
- **Go Templates**: Compiled to `dist/index.html` and other HTML files
- **Static Assets**: Copied to `dist/` (logo, etc.)

## Build Structure

1. **Assets** (CSS/JS): Compiled to `assets/dist/`
2. **Go Templates**: Compiled to `dist/index.html`
3. **Fragments**: Copied to `dist/signup/` (if needed)
4. **Logo**: Copied to `dist/spendflix-logo.svg`

## Architecture

- **Build Time**: Go templates → HTML static
- **Runtime**: HTML static served by Amplify
- **Interactions**: HTMX handles form submissions
- **Styling**: TailwindCSS compiled to CSS
- **Logic**: TypeScript compiled to JS (minimal, only helpers)
- **Components**: Web Components (Custom Elements) for reusable UI

## Main Files

- `assets/src/main.ts` - Generic functions (Preline initialization, form validation)
- `assets/src/signup.ts` - Signup-specific logic (response transformation)
- `assets/src/floating-input.ts` - Spendflix input web component (spf-input) with validation
- `templates/signup.html` - Main signup page template
- `templates/signup/form.html` - Signup form template
- `cmd/build/main.go` - Build tool that compiles templates and copies assets
- `cmd/server/main.go` - Development server
- `amplify.yml` - AWS Amplify build configuration
- `playwright.config.ts` - E2E test configuration
- `tests/signup.spec.ts` - E2E tests for signup flow
