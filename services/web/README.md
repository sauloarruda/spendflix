# Spendflix Web - Frontend SvelteKit

Frontend application built with SvelteKit, TailwindCSS, and Preline UI components.

## Structure

```
web/
  src/
    routes/                  # SvelteKit routes
      +page.svelte          # Home page
      auth/
        +page.svelte        # Signup page
        confirmation/
          +page.svelte      # Email confirmation page
    lib/
      components/ds/        # Design system components
        Button.svelte       # Button component
        Input.svelte        # Input component with validation
        Container.svelte    # Container component
      client/
        init.ts             # Client-side initialization
    app.html                # Base HTML template
    app.css                 # Global styles
  static/                   # Static assets (logo, etc)
  build/                    # Generated by build (deploy)
  tests/                    # E2E tests (Playwright)
```

## Setup

### 1. Install Dependencies

```bash
cd services/web
npm install
```

### 2. Build

```bash
# Full build
make build

# Or manually:
npm run build
```

The build generates static files in the `build/` directory.

## Development

Start development server:

```bash
cd services/web
make dev
```

This will:

1. Start SvelteKit dev server with hot reload
2. Server runs on `http://localhost:8080`

Access: `http://localhost:8080`

**Note:** SvelteKit automatically rebuilds on file changes.

## Testing

E2E tests using Playwright to validate the complete signup flow.

### Prerequisites

- Node.js 20+
- Go 1.23+
- PostgreSQL (for running the API locally)

### Running Tests Locally

#### 1. Setup

```bash
# Install dependencies
cd services/web
npm install

# Install Playwright browsers
npx playwright install --with-deps chromium
```

#### 2. Configure Environment Variables

Make sure the API is properly configured in `services/auth/.env`:

```env
DATABASE_URL=postgres://user:password@localhost:5432/spendflix?sslmode=disable
PORT=3000
ENCRYPTION_SECRET=your-secret-key
```

#### 3. Run Tests

```bash
# Run all tests (headless - default)
# Automatically starts servers
npm test

# Run with visible browser (local)
npm run test:local

# Run with Playwright interactive UI
npm run test:ui

# Run fast tests (skips build if servers already running)
# Useful when you already have servers running manually
npm run test:fast

# Use environment variable directly
HEADLESS=false npm test
```

**Tip for fast development:**

If you already have servers running (`make dev` in another terminal), use:

```bash
npm run test:fast
```

This skips the build and starts tests immediately, saving time.

### Test Structure

- `tests/signup.spec.ts` - Signup flow tests:
  - Field validation (name and email)
  - Form submission
  - Confirmation code display
  - API error handling

### How It Works

Playwright automatically:

1. Starts the API at `http://localhost:3001` (test port)
2. Builds and starts the web server at `http://localhost:8081` (test port)
3. Runs tests in headless browser
4. Cleans up processes when finished

**Note:** Test servers use different ports (3001 for API, 8081 for web) to avoid conflicts with local development servers.

### Debugging

To debug tests:

```bash
# Run a specific test
npx playwright test signup.spec.ts

# Run with debug mode
npx playwright test --debug

# View HTML report
npx playwright show-report
```

### CI/CD

Tests run automatically on GitHub Actions when there are changes in:

- `services/web/**`
- `services/auth/**`

The workflow is in `.github/workflows/web-e2e.yml`.

## Environment Variables

- `VITE_API_URL`: API Gateway URL (default: `http://localhost:3000`)

**Note:** `VITE_` prefix is required for SvelteKit to expose the variable to the client.

### Getting API Gateway URL

To get the API Gateway URL from the deployed auth service:

```bash
cd services/auth
serverless info --stage dev
```

Look for the `endpoint` line in the output. The base URL (without the `/auth/sign-up` path) should be used for `VITE_API_URL`.

Example output:

```
endpoint: POST - https://yrltx77a47.execute-api.us-east-2.amazonaws.com/auth/sign-up
```

In this case, set `VITE_API_URL=https://yrltx77a47.execute-api.us-east-2.amazonaws.com`

## AWS Amplify Configuration

### Prerequisites

1. **Node.js Runtime**: Amplify needs Node.js 20+ to build SvelteKit. This is available by default in Amplify.

2. **Environment Variables**: Set the following in Amplify Console → App settings → Environment variables:
   - `VITE_API_URL`: Your API Gateway URL (e.g., `https://api.example.com`)

**Note:** The `VITE_` prefix is required for SvelteKit to expose the variable to the client.

### Build Configuration

The `amplify.yml` file is already configured with the following build steps:

```yaml
version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm install
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: build
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
      - .svelte-kit/**/*
```

### Deployment Steps

#### Option 1: Deploy Without Git (Recommended for Testing)

You can deploy directly without connecting to Git repository:

```bash
# 1. Build locally
cd services/web
make build

# 2. Create deployment
DEPLOYMENT=$(aws amplify create-deployment \
  --app-id d37t3chm3rgne2 \
  --branch-name main \
  --region us-east-2 \
  --output json)

JOB_ID=$(echo $DEPLOYMENT | jq -r '.jobId')
ZIP_URL=$(echo $DEPLOYMENT | jq -r '.zipUploadUrl')

# 3. Upload built files
cd build
zip -r ../deploy.zip .
curl -X PUT "$ZIP_URL" --upload-file ../deploy.zip
cd ..

# 4. Start deployment
aws amplify start-job \
  --app-id d37t3chm3rgne2 \
  --branch-name main \
  --job-id $JOB_ID \
  --job-type RELEASE \
  --region us-east-2

# Clean up
rm deploy.zip
```

#### Option 2: AWS Console (Manual with Git)

1. **Get API Gateway URL**:

   ```bash
   cd services/auth
   serverless info --stage dev
   ```

   Copy the base URL from the `endpoint` output (without the `/auth/sign-up` path).

2. **Connect Repository**: Connect your GitHub repository to AWS Amplify
3. **Configure Build Settings**:
   - Root directory: `services/web`
   - Build image: Use default Node.js 20+ image
4. **Set Environment Variables**: Add `VITE_API_URL` in the Amplify console with the URL obtained in step 1
5. **Deploy**: Amplify will automatically:
   - Run `npm install`
   - Run `npm run build` (builds SvelteKit app)
   - Serve content from `build/` directory

#### Option 3: AWS CLI (Programmatic with Git)

You can configure Amplify programmatically using AWS CLI:

```bash
# First, get the API Gateway URL from the auth service
cd services/auth
VITE_API_URL=$(serverless info --stage dev | grep endpoint | sed 's/.*https:\/\/\([^/]*\).*/https:\/\/\1/')

# Create Amplify app
aws amplify create-app \
  --name spendflix-web \
  --platform WEB \
  --environment-variables VITE_API_URL=$VITE_API_URL \
  --region us-east-2

# Note: Repository connection requires GitHub OAuth token
# Connect repository via AWS Console: App settings → General → Repository
# Or use: aws amplify create-deployment --app-id <app-id> --branch-name main

# Create branch
aws amplify create-branch \
  --app-id <app-id> \
  --branch-name main \
  --framework WEB

# Set environment variables (get VITE_API_URL from auth service first)
cd services/auth
VITE_API_URL=$(serverless info --stage dev | grep endpoint | sed 's/.*https:\/\/\([^/]*\).*/https:\/\/\1/')
aws amplify update-app \
  --app-id <app-id> \
  --environment-variables VITE_API_URL=$VITE_API_URL \
  --region us-east-2

# Start deployment from Git (requires repository connection)
aws amplify start-job \
  --app-id <app-id> \
  --branch-name main \
  --job-type RELEASE \
  --region us-east-2
```

#### Option 3b: Deploy Without Git Push (Direct Upload)

You can deploy directly without pushing to Git by uploading the built files:

```bash
# 1. Build locally first
cd services/web
make build

# 2. Create a deployment (this creates a zip file upload URL)
DEPLOYMENT=$(aws amplify create-deployment \
  --app-id <app-id> \
  --branch-name main \
  --region us-east-2 \
  --output json)

# Extract jobId and zipUploadUrl from the response
JOB_ID=$(echo $DEPLOYMENT | jq -r '.jobId')
ZIP_URL=$(echo $DEPLOYMENT | jq -r '.zipUploadUrl')

# 3. Create zip file from build/ directory
cd build
zip -r ../deploy.zip .

# 4. Upload zip file to the provided URL
curl -X PUT "$ZIP_URL" --upload-file ../deploy.zip

# 5. Start the deployment job
aws amplify start-job \
  --app-id <app-id> \
  --branch-name main \
  --job-id $JOB_ID \
  --job-type RELEASE \
  --region us-east-2

# Clean up
rm ../deploy.zip
```

**Alternative:** You can also use the Amplify Console → "Deploy without Git repository" option for a simpler UI-based deployment.

#### Option 4: AWS SDK (Go)

You can also use the AWS SDK for Go to configure Amplify programmatically:

```go
package main

import (
    "github.com/aws/aws-sdk-go/aws"
    "github.com/aws/aws-sdk-go/aws/session"
    "github.com/aws/aws-sdk-go/service/amplify"
)

func createAmplifyApp() error {
    sess := session.Must(session.NewSession())
    svc := amplify.New(sess)

    // Get API Gateway URL from auth service deployment
    // Run: cd services/auth && serverless info --stage dev
    // Extract base URL from endpoint output
    apiGatewayURL := "https://yrltx77a47.execute-api.us-east-2.amazonaws.com" // Replace with actual URL

    input := &amplify.CreateAppInput{
        Name: aws.String("spendflix-web"),
        Repository: aws.String("https://github.com/sauloarruda/spendflix.git"),
        Platform: aws.String("WEB"),
        EnvironmentVariables: map[string]*string{
            "VITE_API_URL": aws.String(apiGatewayURL),
        },
        BuildSpec: aws.String(`
version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm install
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: build
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
      - .svelte-kit/**/*
        `),
    }

    result, err := svc.CreateApp(input)
    if err != nil {
        return err
    }

    // Create branch
    branchInput := &amplify.CreateBranchInput{
        AppId:      result.App.AppId,
        BranchName: aws.String("main"),
        Framework:  aws.String("WEB"),
    }

    _, err = svc.CreateBranch(branchInput)
    return err
}
```

#### Option 5: Terraform/CDK

For Infrastructure as Code, you can use Terraform or AWS CDK:

**Terraform example:**

```hcl
# Get API Gateway URL first:
# cd services/auth && serverless info --stage dev
# Extract base URL from endpoint output

resource "aws_amplify_app" "web" {
  name       = "spendflix-web"
  repository = "https://github.com/sauloarruda/spendflix.git"
  platform   = "WEB"

  environment_variables = {
    VITE_API_URL = "https://yrltx77a47.execute-api.us-east-2.amazonaws.com" # Replace with actual URL
  }

  build_spec = file("${path.module}/amplify.yml")
}

resource "aws_amplify_branch" "main" {
  app_id      = aws_amplify_app.web.id
  branch_name = "main"
  framework   = "WEB"
}
```

### Build Output

The build process generates:

- **Static HTML/CSS/JS**: Compiled to `build/`
- **Static Assets**: Copied to `build/` (logo, etc.)

## Architecture

- **Framework**: SvelteKit with Svelte 5 (runes mode)
- **Build Time**: SvelteKit compiles to static HTML/CSS/JS
- **Runtime**: Static files served by Amplify
- **Interactions**: Svelte reactivity handles form submissions
- **Styling**: TailwindCSS with Preline UI components
- **Components**: Svelte components in `src/lib/components/ds/`
- **Routing**: SvelteKit file-based routing

## Main Files

- `src/routes/+page.svelte` - Home page
- `src/routes/auth/+page.svelte` - Signup page
- `src/routes/auth/confirmation/+page.svelte` - Email confirmation page
- `src/lib/components/ds/Button.svelte` - Button component with loading state
- `src/lib/components/ds/Input.svelte` - Input component with validation
- `src/lib/components/ds/Container.svelte` - Container component with loading state
- `src/lib/client/init.ts` - Client-side initialization (Preline UI)
- `src/app.html` - Base HTML template
- `src/app.css` - Global styles
- `svelte.config.js` - SvelteKit configuration
- `vite.config.js` - Vite configuration
- `tailwind.config.js` - TailwindCSS configuration
- `playwright.config.ts` - E2E test configuration
- `tests/signup.spec.ts` - E2E tests for signup flow
